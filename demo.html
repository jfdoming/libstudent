<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Grade Calculator</title>
		<link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
		<link rel="stylesheet" href="demo.css">
		
		<script src="libstudent.js" type="text/javascript"></script>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
		
		<script type="text/javascript">
			function getSelectedValue() {
				if (!selector.dataset.selectedKey && selector.dataset.selectedKey != 0) {
					return "";
				}
				
				return record[selector.dataset.selectedKey];
			}
			
			function getSelectedKey() {
				if (!selector.dataset.selectedKey && selector.dataset.selectedKey != 0) {
					return 0;
				}
				
				return selector.dataset.selectedKey;
			}
			
			function getSelectorArrowString() {
				if (selector.dataset.selecting && selector.dataset.selecting == "true") {
					return "&nbsp;&nbsp;&#x25B2;";
				} else {
					return "&nbsp;&nbsp;&#x25BC;";
				}
			}
			
			function setSelectorLabel(label) {
				selectorLabel.textContent = label;
				selectorArrow.innerHTML = getSelectorArrowString();
				selector.dataset.selectorLabel = label;
			}
			
			function setSelectedKey(key) {
				if (!record[key]) {
					return;
				}
				
				setSelectorLabel(record[key].name);
				selector.dataset.selectedKey = key;
				localStorage.setItem("selectedCourseId", key);
			}
			
			function showSelector() {
				selector.dataset.selecting = true;
				selector.classList.add("focus");
				setSelectorLabel(selector.dataset.selectorLabel);
			}
			
			function hideSelector() {
				selector.dataset.selecting = false;
				selector.classList.remove("focus");
				setSelectorLabel(selector.dataset.selectorLabel);
			}
			
			function toggleSelecting() {
				if (selector.dataset.selecting && selector.dataset.selecting == "true") {
					hideSelector();
				} else {
					showSelector();
				}
			}
			
			// ====================== END SELECTOR ============================
			
			// See https://stackoverflow.com/a/105074/
			
			function guid() {
				function s4() {
					return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
				}
				return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
			}
			
			function genUniqueCourseId() {
				let courseId = guid();
				
				if (record[courseId]) {
					return genUniqueCourseId();
				}
				return courseId;
			}
			
			// See https://stackoverflow.com/a/2234986/
			
			function isDescendant(parent, child) {
				var node = child.parentNode;
				while (node != null) {
					if (node == parent) {
						return true;
					}
					node = node.parentNode;
				}
				return false;
			}
			
			function move(arr, oldIndex, newIndex) {
				while (oldIndex < 0) {
					oldIndex += arr.length;
				}
				while (newIndex < 0) {
					newIndex += arr.length;
				}
				if (newIndex >= arr.length) {
					var k = newIndex - arr.length + 1;
					while (k--) {
						arr.push(undefined);
					}
				}
				arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
			};
			
			
			function switchCourse(courseId, doNotSave) {
				hideSelector();
				
				if (getSelectedKey() == courseId) {
					return;
				}
				
				setSelectedKey(courseId);
				
				document.querySelectorAll("#markOutput > tbody#entries > *").forEach(function(el) {
					el.remove();
				});
				markOutput.dataset.oldLength = 0;
				
				onMarksChanged(doNotSave);
			}
			
			function updateDesiredGrade() {
				const value = desiredMark.value;
				const calculatedMark = determineMarksForTarget(record, getSelectedKey(), value);
				if (calculatedMark <= 0) {
					frontText.style.display = "none";
					otherFrontText.textContent = "Congratulations! It is not possible";
					desiredQualifier.textContent = "as low as"
					otherFrontText.style.display = "inline";
				} else if (calculatedMark > 100) {
					frontText.style.display = "none";
					otherFrontText.textContent = "Sorry, but it is not possible";
					desiredQualifier.textContent = "as high as";
					otherFrontText.style.display = "inline";
				} else {
					frontText.style.display = "inline";
					otherFrontText.style.display = "none";
					desiredQualifier.textContent = "of";
					markRequired.textContent = calculatedMark.toFixed(3);
				}
			}
			
			function onload() {
				let savedRecord = localStorage.getItem("primaryRecord");
				if (savedRecord) {
					window.record = JSON.parse(savedRecord);
				} else {
					window.record = {};
				}
				window.selector = document.getElementById("courseSelector");
				window.selectorContainer = document.getElementById("courseSelectorContainer");
				window.selectorLabel = document.getElementById("courseSelectorLabel");
				window.selectorItems = document.getElementById("courseSelectorItems");
				window.selectorArrow = document.getElementById("courseSelectorArrow");
				window.courseDelete = document.getElementById("courseDeleteButton");
				window.courseAdd = document.getElementById("courseAdd");
				window.markName = document.getElementById("name");
				window.mark = document.getElementById("mark");
				window.weight = document.getElementById("weight");
				window.add = document.getElementById("add");
				window.markOutput = document.getElementById("markOutput");
				window.calcOutput = document.getElementById("calcOutput");
				window.markRequired = document.getElementById("markRequired");
				window.frontText = document.getElementById("frontText");
				window.otherFrontText = document.getElementById("otherFrontText");
				window.desiredQualifier = document.getElementById("desiredQualifier");
				window.desiredMark = document.getElementById("desiredMark");
				window.entries = document.getElementById("entries");
				window.entryInput = document.querySelector("tbody.no-border");
				desiredMark.addEventListener("valuechange", updateDesiredGrade);
				
				let selectedCourseId = localStorage.getItem("selectedCourseId");
				
				let index = 0;
				for (let courseId in record) {
					if (index == 0) {
						if (selectedCourseId == null) {
							selectedCourseId = courseId;
						}
					}
					
					setupCourseDisplay(courseId);
					
					index++;
				}
				
				setSelectedKey(selectedCourseId);
				
				if (index <= 0) {
					selector.classList.add("disabled");
					setSelectorLabel("");
				}
				
				document.addEventListener("click", function(evt) {
					if (evt.srcElement == courseSelector || isDescendant(courseSelector, evt.srcElement)) {
						return;
					}
					
					if (selector.dataset.selecting && selector.dataset.selecting == "true") {
						hideSelector();
					}
				});
				
				onMarksChanged(true);
				
				window.sortable = Sortable.create(entries, {
					filter: ".ignoreRow",
					preventOnFilter: true,
					ghostClass: "ghostRow",
					animation: 150,
					onUpdate: (e) => {
						const arr = getSelectedValue().marks;
						// [arr[e.oldIndex], arr[e.newIndex]] = [arr[e.newIndex], arr[e.oldIndex]];
						move(arr, e.oldIndex, e.newIndex);
						updateSaved();
					},
				});
			}
			
			function onSelectorLabelClicked(evt) {
				if (selector.classList.contains("disabled")) {
					return;
				}
				
				if (isDescendant(selectorItems, evt.srcElement)) {
					return;
				}
				
				toggleSelecting();
			}
			
			function onKeydown(evt, el) {
				let change = 0;
				
				switch (evt.key) {
					case "ArrowUp":
						change = 1;
						break;
					case "ArrowDown":
						change = -1;
						break;
				}
				
				if (change != 0) {
					let oldSelSt = el.selectionStart;
					let oldSelEnd = el.selectionEnd;
					el.selectionStart = oldSelSt;
					el.selectionEnd = oldSelEnd;
					el.value = Math.max(el.min, Math.min(el.max, Math.round(el.value) + change));
					
					var event = new Event('valuechange');
					el.dispatchEvent(event);
					
					evt.preventDefault();
					return false;
				}
				return true;
			}
			
			function onInput(evt, el) {
				let data = evt.data;
				if (!data) {
					return false;
				}
				
				return filterInput(data.charCodeAt(0), el);
			}
			
			function filterInput(kc, el) {
				if (((kc != 46 || el.value.replace(".", "").indexOf(".") != -1) && (kc < 48 || kc >= 58)) || +el.value > el.max) {
					let oldSelSt = el.selectionStart;
					let oldSelEnd = el.selectionEnd;
					let oldValue = el.dataset.value;
					
					if (+oldValue > el.max) {
						el.value = el.max;
					} else {
						el.value = oldValue;
					}
					
					var event = new Event('valuechange');
					el.dispatchEvent(event);
					
					el.selectionStart = oldSelSt - 1;
					el.selectionEnd = oldSelEnd - 1;
					return false;
				}
				
				el.dataset.value = el.value;
					
				var event = new Event('valuechange');
				el.dispatchEvent(event);
				return true;
			}
			
			function setupCourseDisplay(courseId) {
				let course = record[courseId];
				if (!course) {
					return;
				}
				
				let option = document.createElement("div");
				option.dataset.courseId = courseId;
				option.textContent = course.name;
				option.addEventListener("click", function() {
					switchCourse(courseId);
				});
				
				selectorItems.appendChild(option);
			}
			
			function attemptCourseAdd() {
				if (!courseAdd.value || courseAdd.value.length <= 0) {
					courseAdd.reportValidity();
					return;
				}
				
				let courseId = genUniqueCourseId();
				addCourse(record, courseId, courseAdd.value);
				selector.classList.remove("disabled");
				
				setupCourseDisplay(courseId);
				switchCourse(courseId);
			}
			
			function attemptCourseRemove() {
				if (Object.keys(record).length <= 0) {
					return;
				}
				
				let courseId = getSelectedKey();
				delete record[courseId];
				selectorItems.querySelector("[data-course-id='" + courseId + "']").remove();
				switchCourse(Object.keys(record)[0]);
				updateInput();
				updateSaved();
			}
			
			function attemptMarkAdd() {
				if (!markName.value || markName.value.length <= 0) {
					markName.reportValidity();
					return;
				}
				if (!mark.value || mark.value.length <= 0) {
					mark.reportValidity();
					return;
				}
				if (!weight.value || weight.value.length <= 0) {
					weight.reportValidity();
					return;
				}
				addMark(record, getSelectedKey(), markName.value, mark.value, weight.value);
				onMarksChanged();
			}
			
			function onMarksChanged(doNotSave) {
				updateInput();
				updateOutput();
				
				if (!doNotSave) {
					updateSaved();
				}
			}
			
			function updateInput() {
				let earnable = determineMarksEarnable(record, getSelectedKey());
				if (earnable <= 0) {
					markName.disabled = true;
					mark.disabled = true;
					weight.disabled = true;
					add.disabled = true;
					
					markName.placeholder = "";
				} else {
					markName.disabled = false;
					mark.disabled = false;
					weight.disabled = false;
					add.disabled = false;
					
					markName.placeholder = "e.g. Quiz 1";
					
					weight.max = earnable;
					filterInput(48, weight);
				}
				
				if (Object.keys(record).length <= 0) {
					setSelectorLabel("");
					selector.classList.add("disabled");
					selector.tabIndex = -1;
					
					courseDelete.disabled = true;
				} else {
					selector.tabIndex = 0;
					courseDelete.disabled = false;
				}
			}
			
			function updateIndices(el) {
				if (el && el.lastChild) {
					el.lastChild.firstChild.dataset.index--;
					updateIndices(el.previousSibling);
				}
			}
			
			function updateOutput() {
				if (!markOutput.dataset.oldLength) {
					markOutput.dataset.oldLength = 0;
				}
				
				let course = record[getSelectedKey()];
				if (course) {
					let marks = course.marks;
					if (marks.length > 0) {
						entryInput.classList.remove("no-border");
					
						let length = marks.length - markOutput.dataset.oldLength;
						for (; length > 0; --length) {
							let pair = marks[marks.length - length];
							if (!pair) {
								continue;
							}
							
							let row = document.createElement("tr");
							entries.appendChild(row);
							let nameCell = row.insertCell(0);
							let markCell = row.insertCell(1);
							let weightCell = row.insertCell(2);
							let xCell = row.insertCell(3);
							let xText = document.createElement("span");
							
							nameCell.textContent = pair.name;
							markCell.textContent = pair.mark;
							weightCell.textContent = pair.weight;
							xText.classList.add("x");
							xText.dataset.index = marks.length - length;
							xText.tabIndex = 0;
							
							let callback = function() {
								marks.splice(xText.dataset.index, 1);
								updateIndices(xCell.parentNode);
								xCell.parentNode.remove();
								
								markOutOfDate(course);
								onMarksChanged();
							};
							xText.addEventListener("keydown", function(evt) {
								handleButtonKeydown(evt, callback);
							});
							xText.addEventListener("click", callback);
							
							xCell.appendChild(xText);
							markOutput.dataset.oldLength++;
						}
					} else {
						entryInput.classList.add("no-border");
					}
					markOutput.dataset.oldLength = marks.length;
					
					let calcResult = "";
					let selectedCourseId = getSelectedKey();
					let achieved = determineMarksAchieved(record, selectedCourseId).toFixed(3);
					let missed = determineMarksMissed(record, selectedCourseId).toFixed(3);
					let earnable = determineMarksEarnable(record, selectedCourseId).toFixed(3);
					let marksIf100 = determineMarksIf100(record, selectedCourseId).toFixed(3);
					let meanSoFar = determineMeanSoFar(record, selectedCourseId).toFixed(3);
					let target = 75;
					let marksForTarget = determineMarksForTarget(record, selectedCourseId, target).toFixed(3);
					
					calcResult += `You have achieved ${achieved}/100 possible marks.<br/>`;
					calcResult += `You have missed ${missed}/100 possible marks.<br/>`;
					if (earnable == 0) {
						calcResult += `Your final grade is ${achieved}%.<br/>`;
						calcResult += `Your GPA for this course is ${determineGPAScore(record, selectedCourseId, uoftGPAScorer).toFixed(1)}.<br/>`;
					} else {
						calcResult += `You still have the opportunity to earn ${earnable}/100 marks.<br/>`;
						calcResult += `If you want your mark to stay the same, you should get ${meanSoFar}% on your remaining assessments.<br/>`;
						calcResult += `If you get 100 on your remaining assessments, your final grade will be ${marksIf100}%.<br/>`;
						calcResult += `If you get 0 on your remaining assessments, your final grade will be ${achieved}%.<br/>`;
					}
					
					calcOutput.innerHTML = calcResult;
					
					updateDesiredGrade();
				} else {
					calcOutput.textContent = "No course selected.";
				}
			}
			
			function updateSaved() {
				localStorage.setItem("primaryRecord", JSON.stringify(record));
			}
			
			function handleButtonKeydown(evt, callback) {
				let code = evt.which;
				if (code == 13 || code == 32) {
					callback(evt);
				}
			}
		</script>
	</head>
	<body onload="onload()">
		<div id="container">
			<div id="courseSelectorContainer">
				<span>Choose a course:&nbsp;</span>
				<div id="courseSelector" onclick="onSelectorLabelClicked(event)" onkeydown="handleButtonKeydown(event, onSelectorLabelClicked)" tabindex="0">
					<span id="courseSelectorLabel"></span><span id="courseSelectorArrow"></span>
					<div id="courseSelectorItems"></div>
				</div>
				<input style="background: red;border: 1px solid red;" type="button" id="courseDeleteButton" value="Delete course" onclick="attemptCourseRemove()"/>
				<span id="separator">- or -</span>
				<input type="text" id="courseAdd" required placeholder="e.g. MAT 135..."/>
				<input type="button" id="courseAddButton" value="Add course" onclick="attemptCourseAdd()"/>
			</div>
			<div id="body-wrapper">
				<div id="table-container">
					<table id="markOutput">
						<thead>
							<tr>
								<th>Assessment</th>
								<th>Mark</th>
								<th>Weight</th>
								<th></th>
							</tr>
						</thead>
						<tbody class="no-border">
							<tr class="ignoreRow">
								<td><input type="text" id="name" required style="width: 20ch;"/></td>
								<td><input type="text" id="mark" required maxlength="10" min="0" max="100" value="100" data-value="100" onkeydown="onKeydown(event, this)" oninput="onInput(event, this)"/></td>
								<td><input type="text" id="weight" required maxlength="10" min="0" max="100" value="5" data-value="5" onkeydown="onKeydown(event, this)" oninput="onInput(event, this)"/></td>
								<td><input type="button" id="add" value="Add mark" onclick="attemptMarkAdd()"/></td>
							</tr>
						</tbody>
						<tbody id="entries"/>
					</table>
				</div>
				<div id="analytics">
					<div id="calcOutput"></div>
					<div id="desiredGrade">
						<span id="otherFrontText"></span><span id="frontText">You need to get <span id="markRequired">0</span>% on your remaining assessments in order</span> to get a final grade <span id="desiredQualifier">of</span> <input type="text" id="desiredMark" style="width: 5ch" required maxlength="10" min="0" max="100" value="60" data-value="100" onkeydown="onKeydown(event, this)" oninput="onInput(event, this)"/> .
					</div>
				</div>
			</div>
		</div>
	</body>
</html>